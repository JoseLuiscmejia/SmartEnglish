<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA CONFIG -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#a1c4fd">
    <title>Magic School 2.0</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');

        :root {
            --bg-grad-1: #a1c4fd;
            --bg-grad-2: #c2e9fb;
            --card-bg: #ffffff;
            --text-main: #3a3a3a;
            --primary: #4facfe;
            --accent: #ff9a9e;
            --shadow: 0 8px 20px rgba(0,0,0,0.1);
            
            /* Crucigrama Dark */
            --cw-bg: #1a1a1a;
            --cw-cell: #eee;
            --cw-highlight: #64b5f6;
            --cw-selected: #ffeb3b;
        }

        /* MODO OSCURO */
        body.dark {
            --bg-grad-1: #1e1e2f;
            --bg-grad-2: #2c2c3e;
            --card-bg: #2c2c3e;
            --text-main: #f0f0f0;
            --primary: #00f2fe;
            --shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background: linear-gradient(to bottom, var(--bg-grad-1), var(--bg-grad-2));
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-main);
            transition: background 0.5s ease, color 0.5s ease;
        }

        /* HEADER */
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            transition: background 0.5s ease;
        }

        header h1 { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        
        #user-stats { display: flex; gap: 10px; font-size: 0.85rem; align-items: center;}
        .stat-pill { background: rgba(0,0,0,0.05); padding: 5px 12px; border-radius: 20px; font-weight: 600; border: 1px solid rgba(0,0,0,0.1); }
        #theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 5px;}

        /* MAIN */
        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }

        /* CARDS */
        .modern-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, background 0.5s ease;
        }

        /* TRADUCTOR */
        .trans-input {
            width: 100%; border: none; font-size: 1.2rem; outline: none;
            border-bottom: 2px solid #eee; text-align: center; color: var(--text-main);
            padding: 10px; background: transparent; font-weight: 600;
        }
        .trans-btn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white; border: none; padding: 12px; border-radius: 12px;
            font-weight: 600; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4);
        }

        /* GAMES GRID */
        .games-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .game-card {
            background: var(--card-bg); padding: 20px; border-radius: 20px;
            box-shadow: var(--shadow); text-align: center; cursor: pointer;
            transition: transform 0.2s ease, background 0.5s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 130px;
        }
        .game-card:active { transform: translateY(5px); }
        .game-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .game-title { font-weight: 700; font-size: 0.9rem; }
        .game-desc { font-size: 0.7rem; opacity: 0.7; }

        /* VOICE CARD */
        .voice-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; }
        .voice-controls { display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px; }
        .lang-select { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 10px; font-weight: 600; outline: none; font-size: 0.8rem; width: 45%;}
        .lang-select option { color: #333; }
        .mic-btn { background: white; color: #764ba2; width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; transition: 0.2s; }
        .mic-btn.listening { background: #ff4b4b; color: white; animation: pulse 1s infinite; }

        /* CHIPS VOCABULARIO */
        .cat-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .cat-chip {
            background: var(--card-bg); padding: 10px 20px; border-radius: 25px;
            font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; display: flex; align-items: center; gap: 8px; 
            border: 1px solid rgba(0,0,0,0.05); transition: transform 0.1s;
        }
        .cat-chip:active { transform: scale(0.95); }

        /* FOOTER */
        footer { background: rgba(255,255,255,0.5); text-align: center; padding: 15px; font-size: 0.8rem; color: var(--text-main); backdrop-filter: blur(10px); }

        /* BIENVENIDA */
        #welcomeScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.5s ease; }
        .start-btn { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px 60px; border-radius: 50px; font-size: 1.5rem; border: none; font-weight: bold; margin-top: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4); }

        /* MODALES */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 150; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-content { width: 90%; max-width: 400px; background: var(--card-bg); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .close-btn { background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; color: #333; }

        /* GRID DETALLE */
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .detail-card { background: rgba(0,0,0,0.03); border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .detail-card:active { background: rgba(0,0,0,0.1); }

        /* CRUCIGRAMA DARK PRO */
        .cw-screen { background: #121212; position: absolute; top:0; left:0; width:100%; height:100%; z-index:200; display:none; flex-direction:column; color: white; }
        .cw-header { background: #1e1e1e; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .cw-grid-area { flex:1; display:flex; justify-content:center; align-items:center; overflow:auto; padding:10px; background: #000; }
        .cw-table { display:grid; gap:1px; background:#333; padding:1px; border:1px solid #444; }
        .cw-cell { width:36px; height:36px; background:#eee; display:flex; justify-content:center; align-items:center; font-weight:900; font-size:1.2rem; color:#111; position:relative; cursor:pointer; }
        .cw-cell.black { background:#121212; pointer-events:none; }
        .cw-cell.active-word { background:var(--cw-highlight) !important; color: #000;}
        .cw-cell.selected { background:var(--cw-selected) !important; color: #000;}
        .cw-clue-box { background:#263238; padding:15px; border-left:5px solid #4fc3f7; color:white; display:flex; align-items:center; min-height:80px; }
        .fab-check { position:absolute; bottom:100px; right:20px; background:#58cc02; color:white; width:60px; height:60px; border-radius:50%; font-size:2rem; border:none; box-shadow:0 5px 15px rgba(0,0,0,0.5); cursor:pointer; z-index:50; display:flex; justify-content:center; align-items:center;}
        .cw-pack-grid { padding:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px; overflow-y:auto; background:#121212; height:100%; }
        .cw-pack-card { background:#1e1e1e; border-radius:10px; overflow:hidden; cursor:pointer; border-bottom:4px solid #000; }

        /* ACHIEVEMENT MODAL */
        #achievement-modal { position:fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.8); z-index:1000; }
        .ach-content { background:white; padding:30px; border-radius:20px; text-align:center; animation: bounceIn 0.5s; }
        
        /* CANVAS CONFETTI */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        #hiddenInput { position: absolute; opacity: 0; top: -1000px; }

        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        @keyframes bounceIn { from {transform:scale(0.5);} to {transform:scale(1);} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

    </style>
</head>
<body>

<div class="app-shell">
    
    <!-- BIENVENIDA -->
    <div id="welcomeScreen">
        <img src="https://cdn-icons-png.flaticon.com/512/4322/4322992.png" width="120" style="margin-bottom:20px">
        <h1 style="color:#333; font-weight:800;">Magic School 2.0</h1>
        <button class="start-btn" onclick="enterApp()">COMENZAR üöÄ</button>
    </div>

    <!-- HEADER -->
    <header>
        <h1>ü¶ä Magic School</h1>
        <div id="user-stats">
            <div class="stat-pill">üî• <span id="streak">1</span></div>
            <div class="stat-pill">‚≠ê <span id="points">0</span></div>
            <button id="theme-toggle">üåô</button>
        </div>
    </header>

    <!-- MAIN -->
    <main>
        <!-- JUEGOS PRINCIPALES -->
        <section class="games-grid">
            <div class="game-card" onclick="alert('Abre Etapas en el men√∫')">
                <div class="game-icon">üó∫Ô∏è</div>
                <div class="game-title">Etapas</div>
            </div>
            <div class="game-card" onclick="openCrosswordMenu()">
                <div class="game-icon">üß©</div>
                <div class="game-title">Crucigrama</div>
            </div>
            <div class="game-card" onclick="alert('Pr√≥ximamente')">
                <div class="game-icon">‚ôüÔ∏è</div>
                <div class="game-title">L√≥gica</div>
            </div>
            <div class="game-card" onclick="alert('Pr√≥ximamente')">
                <div class="game-icon">üéÆ</div>
                <div class="game-title">Arcade</div>
            </div>
        </section>

        <!-- TRADUCTOR DE VOZ -->
        <section class="modern-card voice-card">
            <div class="voice-controls">
                <select id="sourceLang" class="lang-select">
                    <option value="es-ES">Espa√±ol üá™üá∏</option>
                    <option value="en-US">English üá∫üá∏</option>
                </select>
                <span>‚û°</span>
                <select id="targetLang" class="lang-select">
                    <option value="en">Ingl√©s üá∫üá∏</option>
                    <option value="fr">Franc√©s üá´üá∑</option>
                    <option value="it">Italiano üáÆüáπ</option>
                    <option value="pt">Portugu√©s üáßüá∑</option>
                </select>
            </div>
            <div class="mic-btn" id="micBtn" onclick="startVoiceTranslation()">üé§</div>
            <p id="voiceStatus" style="margin-top:15px; font-size:0.9rem; font-weight:600;">Toca y habla...</p>
        </section>

        <!-- CATEGOR√çAS -->
        <section>
            <h3 style="margin-bottom:15px; font-size:0.9rem; opacity:0.7;">VOCABULARIO</h3>
            <div class="cat-container">
                <div class="cat-chip" onclick="openCategory('greetings', 'Saludos')">üëã Saludos</div>
                <div class="cat-chip" onclick="openCategory('animals', 'Animales')">üê∂ Animales</div>
                <div class="cat-chip" onclick="openCategory('fruits', 'Frutas')">üçé Frutas</div>
                <div class="cat-chip" onclick="openCategory('colors', 'Colores')">üé® Colores</div>
                <div class="cat-chip" onclick="openCategory('numbers', 'N√∫meros')">1Ô∏è‚É£ N√∫meros</div>
                <div class="cat-chip" onclick="openCategory('family', 'Familia')">üë™ Familia</div>
                <div class="cat-chip" onclick="openCategory('body', 'Cuerpo')">üëÄ Cuerpo</div>
                <div class="cat-chip" onclick="openCategory('verbs', 'Verbos')">üèÉ Verbos</div>
            </div>
        </section>
    </main>

    <footer>
        <p>Magic School Pro ¬© 2025</p>
    </footer>

</div>

<!-- CANVAS CONFETI -->
<canvas id="confetti-canvas"></canvas>

<!-- MODAL LOGRO -->
<div id="achievement-modal">
    <div class="ach-content">
        <div style="font-size:3rem;">üèÜ</div>
        <h2>¬°Nivel Superado!</h2>
        <p>Has ganado 50 puntos</p>
        <button class="start-btn" style="margin-top:10px; font-size:1rem;" onclick="document.getElementById('achievement-modal').style.display='none'">Genial</button>
    </div>
</div>

<!-- MODAL CATEGORIA -->
<div id="modalCategory" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title" id="catTitle">...</span>
            <button class="close-btn" onclick="closeModal('modalCategory')">‚úñ</button>
        </div>
        <div class="modal-body">
            <div class="detail-grid" id="catDetailGrid"></div>
        </div>
    </div>
</div>

<!-- CRUCIGRAMA PACKS -->
<div id="packsScreen" class="cw-screen">
    <div class="cw-header"><button class="cw-close-btn" onclick="closePacks()">‚¨Ö</button><span>NIVELES</span><div></div></div>
    <div class="cw-pack-grid" id="packsGrid"></div>
</div>

<!-- CRUCIGRAMA GAME -->
<div id="gameScreen" class="cw-screen" style="z-index:250">
    <div class="cw-header"><button class="cw-close-btn" onclick="closeGame()">‚úñ</button><span id="gameTitle">Nivel</span><div></div></div>
    <div class="cw-grid-area"><div id="gridTable" class="cw-table"></div></div>
    <button class="fab-check" onclick="checkCrossword()">‚úì</button>
    <div class="cw-clue-box"><div id="currentClueDisplay" style="font-size:1.1rem; font-weight:bold;">Selecciona...</div></div>
    <input type="text" id="hiddenInput" autocomplete="off" class="cw-input-hidden">
</div>

<script>
    let pts = 0;
    let isListening = false, recognition = null;

    // --- DATA ---
    const db = {
        greetings: [{i:'üëã',e:'Hello',s:'Hola'},{i:'üö∂',e:'Bye',s:'Adi√≥s'},{i:'üåÖ',e:'Good Morning',s:'Buenos d√≠as'},{i:'üôè',e:'Thank you',s:'Gracias'}],
        animals: [{i:'üê∂',e:'Dog',s:'Perro'},{i:'üê±',e:'Cat',s:'Gato'},{i:'ü¶Å',e:'Lion',s:'Le√≥n'},{i:'üêØ',e:'Tiger',s:'Tigre'},{i:'üêò',e:'Elephant',s:'Elefante'},{i:'üêµ',e:'Monkey',s:'Mono'}],
        fruits: [{i:'üçé',e:'Apple',s:'Manzana'},{i:'üçå',e:'Banana',s:'Pl√°tano'},{i:'üçá',e:'Grapes',s:'Uvas'},{i:'üçä',e:'Orange',s:'Naranja'},{i:'üçì',e:'Strawberry',s:'Fresa'}],
        colors: [{i:'üî¥',e:'Red',s:'Rojo'},{i:'üîµ',e:'Blue',s:'Azul'},{i:'üü¢',e:'Green',s:'Verde'},{i:'üü°',e:'Yellow',s:'Amarillo'},{i:'‚ö´',e:'Black',s:'Negro'},{i:'‚ö™',e:'White',s:'Blanco'}],
        family: [{i:'üë®',e:'Father',s:'Pap√°'},{i:'üë©',e:'Mother',s:'Mam√°'},{i:'üë∂',e:'Baby',s:'Beb√©'}],
        body: [{i:'üëÄ',e:'Eyes',s:'Ojos'},{i:'üëÉ',e:'Nose',s:'Nariz'},{i:'üëÑ',e:'Mouth',s:'Boca'}],
        numbers: [{i:'1Ô∏è‚É£',e:'One',s:'1'},{i:'2Ô∏è‚É£',e:'Two',s:'2'},{i:'3Ô∏è‚É£',e:'Three',s:'3'}],
        verbs: [{i:'üèÉ',e:'Run',s:'Correr'},{i:'üèä',e:'Swim',s:'Nadar'},{i:'üìñ',e:'Read',s:'Leer'}]
    };

    // --- CRUCIGRAMAS ---
    const packs = [
        { id:0, title:"Nivel 1", diff:"F√°cil", s:3, l:[['R','E','D'],['#','#','O'],['#','#','G']], c:["1. Color de la sangre","2. Animal que ladra"], sol:{'0-0':'R','0-1':'E','0-2':'D','1-2':'O','2-2':'G'} },
        { id:1, title:"Nivel 2", diff:"Medio", s:4, l:[['C','A','T','#'],['#','#','O','#'],['#','#','A','#'],['#','#','D','#']], c:["1. Animal miau","2. Animal salta"], sol:{'0-0':'C','0-1':'A','0-2':'T','1-2':'O','2-2':'A','3-2':'D'} }
    ];

    let currentPack, selectedCell, currentDir='H', gridState;

    // --- INIT ---
    function enterApp() {
        document.getElementById('welcomeScreen').style.transform = "translateY(-100%)";
        speak("");
    }

    // Dark Mode
    document.getElementById("theme-toggle").addEventListener("click",()=>{
        document.body.classList.toggle("dark");
        document.getElementById("theme-toggle").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });

    function speak(txt, lang='en-US') {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(txt);
        u.lang = lang; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    function addPoints(n) {
        pts += n;
        document.getElementById('points').innerText = pts;
        if(pts % 50 === 0) {
            document.getElementById('achievement-modal').style.display='flex';
            showConfetti();
        }
    }

    function openModal(id){ document.getElementById(id).style.display='flex'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }

    // --- CATEGORIAS ---
    function openCategory(cat, title) {
        document.getElementById('catTitle').innerText = title;
        const grid = document.getElementById('catDetailGrid');
        grid.innerHTML = '';
        if(db[cat]) {
            db[cat].forEach(i => {
                let el = document.createElement('div'); el.className='detail-card';
                el.innerHTML = `<div style="font-size:2.5rem">${i.i}</div><div style="font-weight:bold;color:var(--text-main);margin-top:5px;">${i.s}</div>`;
                el.onclick = () => speak(i.e);
                grid.appendChild(el);
            });
        }
        openModal('modalCategory');
    }

    // --- TRADUCTOR VOZ ---
    function startVoiceTranslation() {
        if(isListening) { if(recognition) recognition.stop(); resetMic(); return; }
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) { alert("Navegador no soporta voz"); return; }
        
        recognition = new Speech();
        recognition.lang = document.getElementById('sourceLang').value;
        const target = document.getElementById('targetLang').value;
        
        const mic = document.getElementById('micBtn');
        mic.classList.add('listening');
        document.getElementById('voiceStatus').innerText = "Escuchando...";
        isListening = true;
        
        recognition.onresult = (e) => {
            const txt = e.results[0][0].transcript;
            translateAndSpeak(txt, target);
        };
        recognition.onend = resetMic;
        recognition.start();
    }

    function resetMic() {
        isListening = false;
        document.getElementById('micBtn').classList.remove('listening');
        document.getElementById('voiceStatus').innerText = "Toca y habla...";
    }

    async function translateAndSpeak(text, target) {
        try{
            const source = document.getElementById('sourceLang').value.split('-')[0];
            let r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(text)}`);
            let j = await r.json();
            let trans = j[0][0][0];
            
            document.getElementById('voiceStatus').innerText = `${text} ‚ûù ${trans}`;
            
            let langMap = {'en':'en-US','fr':'fr-FR','it':'it-IT','de':'de-DE','pt':'pt-BR'};
            speak(trans, langMap[target] || 'en-US');
        } catch(e) { speak("Error"); }
    }

    // --- CRUCIGRAMA ---
    function openCrosswordMenu() {
        openModal('packsScreen');
        const grid = document.getElementById('packsGrid'); grid.innerHTML = '';
        packs.forEach((p, idx) => {
            let c = document.createElement('div'); c.className = 'cw-pack-card';
            c.innerHTML = `<div class="cw-pack-info"><div style="font-weight:bold; font-size:1.1rem; color:white;">${p.title}</div><div style="color:#aaa; font-size:0.8rem;">${p.diff}</div></div>`;
            c.onclick = () => loadCrossword(idx);
            grid.appendChild(c);
        });
    }
    function closePacks() { document.getElementById('packsScreen').style.display='none'; }
    function closeGame() { document.getElementById('gameScreen').style.display='none'; }

    function loadCrossword(idx) {
        currentPack = packs[idx];
        document.getElementById('gameTitle').innerText = currentPack.title;
        document.getElementById('gameScreen').style.display = 'flex';
        buildBoard(currentPack);
    }

    function buildBoard(pack) {
        const board = document.getElementById('gridTable');
        board.style.gridTemplateColumns = `repeat(${pack.s}, 1fr)`;
        board.innerHTML = '';
        gridState = [];

        for(let r=0; r<pack.s; r++) {
            let rowArr = [];
            for(let c=0; c<pack.s; c++) {
                const char = pack.l[r][c];
                const cell = document.createElement('div');
                if(char === '#') cell.className = 'cw-cell black';
                else {
                    cell.className = 'cw-cell';
                    const input = document.createElement('input');
                    input.className = 'cw-input-hidden'; 
                    input.dataset.r = r; input.dataset.c = c;
                    cell.innerHTML = `<span class="val"></span>`;
                    cell.onclick = () => selectCell(r, c);
                }
                board.appendChild(cell);
                rowArr.push({el:cell, sol:char, val:''});
            }
            gridState.push(rowArr);
        }
        const inp = document.getElementById('hiddenInput');
        inp.oninput = (e) => handleInput(e.target.value);
    }

    function selectCell(r,c) {
        selectedCell = {r,c};
        const clue = currentPack.c.join(' | ');
        document.getElementById('currentClueDisplay').innerText = clue;
        updateVisuals();
        document.getElementById('hiddenInput').value = '';
        document.getElementById('hiddenInput').focus();
    }

    function updateVisuals() {
        document.querySelectorAll('.cw-cell').forEach(e => e.classList.remove('selected'));
        gridState[selectedCell.r][selectedCell.c].el.classList.add('selected');
    }

    function handleInput(char) {
        if(!char) return;
        let l = char.slice(-1).toUpperCase();
        let cell = gridState[selectedCell.r][selectedCell.c];
        cell.val = l;
        cell.el.querySelector('.val').innerText = l;
        
        if(selectedCell.c + 1 < currentPack.s && gridState[selectedCell.r][selectedCell.c+1].sol !== '#') {
            selectCell(selectedCell.r, selectedCell.c+1);
        }
    }

    function checkCrossword() {
        let correct = true;
        for(let r=0; r<gridState.length; r++) {
            for(let c=0; c<gridState[0].length; c++) {
                let cell = gridState[r][c];
                if(cell.sol !== '#') {
                    if(cell.val !== cell.sol) { cell.el.style.color='red'; correct=false; }
                    else { cell.el.style.color='#58cc02'; }
                }
            }
        }
        if(correct) { 
            addPoints(50);
            setTimeout(closeGame, 2000); 
        }
    }

    // --- CONFETI ---
    function showConfetti() {
        const canvas = document.getElementById("confetti-canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        
        const colors = ["#ff0a54","#ff477e","#ff7096","#ff85a1","#fbb1b1"];
        let particles = [];
        for(let i=0;i<100;i++){ particles.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*6+4, color: colors[Math.floor(Math.random()*colors.length)], speed: Math.random()*3+2 }); }
        
        let count=0;
        function draw(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p=>{
                ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill();
                p.y += p.speed; if(p.y>canvas.height){p.y=0;}
            });
            count++; if(count<100) requestAnimationFrame(draw); else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        draw();
    }

</script>
</body>
</html>


