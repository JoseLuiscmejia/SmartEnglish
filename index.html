<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic School</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg-body: #00d2ff;
            --card-bg: #ffffff;
            --primary: #00c853; 
            --secondary: #ff6d00;
            --accent: #6200ea;
            --font-main: 'Fredoka', sans-serif;
            --border-radius: 30px;
            --shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-body);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overscroll-behavior: none;
        }

        body.mode-adult {
            background: #b0bec5;
            --font-main: 'Roboto', sans-serif;
            --border-radius: 15px;
        }

        .app-container {
            width: 95%;
            max-width: 420px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 95dvh;
            overflow: hidden;
            position: relative;
            border: 5px solid white;
            box-sizing: border-box;
        }

        .scroll-content {
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-right: 2px;
            padding-bottom: 20px;
        }

        /* --- HEADER & CONTROLS --- */
        .mode-switcher { 
            display: flex; background: #eee; padding: 4px; border-radius: 50px; 
            margin-bottom: 5px; flex-shrink: 0;
        }
        .switch-btn { 
            flex: 1; padding: 8px; border: none; border-radius: 50px; cursor: pointer; 
            font-weight: bold; background: transparent; color: #777; transition: 0.3s;
        }
        .switch-btn.active-kids { background: var(--secondary); color: white; }
        .switch-btn.active-adult { background: #455a64; color: white; }

        .header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        h1 { margin: 0; color: var(--primary); font-size: 1.8rem; }
        .score-pill { 
            background: #FFD700; color: #e65100; padding: 5px 15px; 
            border-radius: 20px; font-weight: bold; cursor: pointer; border: 2px solid #ffca28;
        }

        /* --- ESTAD√çSTICAS --- */
        .stats-row {
            display: flex; justify-content: space-between; gap: 10px; margin-bottom: 5px; flex-shrink: 0;
        }
        .stat-oval {
            flex: 1; border: 2px solid black; border-radius: 50px; background: white;
            text-align: center; padding: 5px 2px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .stat-title { font-size: 0.6rem; text-transform: uppercase; font-weight: bold; color: #333; letter-spacing: 1px; }
        .stat-value { font-size: 1rem; font-weight: 900; color: #000; }

        /* --- BARRA JUEGOS --- */
        .games-bar { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; flex-shrink: 0;}
        .game-btn-purple { background: #6200ea; color: white; border-radius: 15px; border:none; min-width: 75px; height: 60px; cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:bold; }
        .game-btn-pink { background: #e91e63; color: white; border-radius: 15px; border:none; min-width: 75px; height: 60px; cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:bold;}
        .game-btn-green { background: #00c853; color: white; border-radius: 15px; border:none; min-width: 75px; height: 60px; cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:bold;}
        .game-btn-blue { background: #546e7a; color: white; border-radius: 15px; border:none; min-width: 75px; height: 60px; cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; font-weight:bold;}
        .game-label { font-size: 0.7rem; margin-top: 2px; }
        .game-icon { font-size: 1.4rem; }

        /* --- INPUT --- */
        .input-box { position: relative; flex-shrink: 0;}
        textarea { 
            width: 100%; height: 60px; border: 3px solid #e0e0e0; border-radius: 20px; 
            padding: 15px 50px 15px 15px; font-size: 1.1rem; font-family: inherit; 
            resize: none; outline: none; box-sizing: border-box; text-align: left;
        }
        textarea:focus { border-color: var(--secondary); }
        
        .mic-btn {
            position: absolute; right: 10px; bottom: 10px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--secondary); color: white; border: none; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .mic-btn.active { background: #ff1744; animation: pulse 1s infinite; }

        .btn-translate { 
            width: 100%; padding: 12px; border: none; border-radius: 50px; 
            background: #00c853; color: white; font-size: 1.2rem; 
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #009624; 
            transition: transform 0.1s; display: flex; justify-content: center; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        .btn-translate:active { transform: translateY(4px); box-shadow: none; }

        .result-compact { background: #e8f5e9; border: 2px solid var(--primary); border-radius: 15px; padding: 10px; display: none; text-align: center; font-size: 1.2rem; color: #1b5e20; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .res-divider { color: #aaa; font-weight: normal; }

        /* --- ZONA APRENDIZAJE --- */
        .learning-zone { margin-top: 10px; display: flex; flex-direction: column; flex: 1; }
        
        .tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .tab-btn {
            background: white; border: 2px solid #eee; border-radius: 15px; padding: 8px 10px;
            min-width: 65px; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .tab-btn.active { border-color: var(--secondary); background: #fff3e0; transform: scale(1.05); }
        .tab-icon { font-size: 1.4rem; }
        .tab-label { font-size: 0.65rem; font-weight: bold; color: #666; margin-top: 3px; }

        .pagination { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; background: #f5f5f5; padding: 5px 10px; border-radius: 50px;}
        .nav-btn { background: white; border: 1px solid #ddd; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .vocab-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding-bottom: 20px;}
        .vocab-item {
            background: white; border-radius: 15px; aspect-ratio: 1; display: flex;
            align-items: center; justify-content: center; font-size: 1.6rem;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
            border: 1px solid transparent;
        }
        .vocab-item:active { transform: scale(0.9); background: var(--secondary); border-color: var(--secondary); }

        /* --- MODALES --- */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 40; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: #ff5252; color: white; border:none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; z-index: 70; }
        
        .game-card { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .phrase-es { font-size: 1.5rem; color: #555; margin-bottom: 20px; font-weight: bold; }
        .phrase-en { font-size: 2rem; color: var(--primary); font-weight: bold; margin-top: 10px; animation: slideIn 0.5s; display: none; }
        .countdown { font-size: 4rem; font-weight: bold; color: var(--secondary); animation: pulse 0.5s infinite; }
        .phrase-controls { display: flex; gap: 10px; margin-top: 30px; width: 100%; }
        .btn-replay { flex:1; background:#ff9800; border:none; padding:15px; border-radius:15px; color:white; font-size:1.5rem; cursor:pointer; }
        .btn-next { flex:2; background:#00c853; border:none; padding:15px; border-radius:15px; color:white; font-weight:bold; font-size:1.2rem; cursor:pointer; }

        .soccer-field { width: 100%; height: 220px; background: #4caf50; border-radius: 10px; position: relative; margin-top: 20px; border: 3px solid white; overflow: hidden; display: flex; justify-content: center; }
        .goal { width: 60%; height: 80px; border: 8px solid white; border-bottom: none; position: absolute; top: 0; }
        .ball { font-size: 3rem; position: absolute; bottom: 10px; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2; }
        .goalkeeper { font-size: 3.5rem; position: absolute; top: 40px; transition: 0.3s; z-index: 1; }
        .soccer-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 20px; }
        .soccer-btn { padding: 15px; border: none; border-radius: 10px; background: #2196f3; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; }

        /* ESTILO NUEVO PARA LOS CONTROLES DEL RETO */
        .reto-controls {
            display: flex; align-items: center; gap: 15px; margin-top: 20px;
        }
        .btn-listen { background: #FFD700; border:none; border-radius: 15px; width: 60px; height: 60px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #ffca28; }
        .btn-mic-big { background: var(--secondary); border:none; border-radius: 50%; width: 90px; height: 90px; font-size: 3rem; color: white; cursor: pointer; box-shadow: 0 6px 0 #e65100; animation: pulse 2s infinite; }
        .btn-skip { background: #b0bec5; border:none; border-radius: 15px; width: 60px; height: 60px; font-size: 1.5rem; cursor: pointer; color: white; }

        #welcomeScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; border-radius: var(--border-radius); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .photo-frame { width: 150px; height: 150px; border-radius: 50%; overflow: hidden; border: 6px solid var(--secondary); margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); background: #eee;}
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        .start-btn { background: var(--secondary); color: white; padding: 15px 50px; border-radius: 50px; font-size: 1.5rem; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 5px 0 #e65100; }

        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        @keyframes slideIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .particle { position: absolute; pointer-events: none; animation: fall 3s linear forwards; z-index: 999;}
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- BIENVENIDA -->
        <div id="welcomeScreen">
            <div class="photo-frame">
                <img src="hola.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4322/4322992.png'" alt="Foto">
            </div>
            <h1 style="color:var(--primary); font-size:2rem; line-height:1.2; margin-bottom: 30px;">¬°Bienvenido!<br>Aprende Jugando</h1>
            <button class="start-btn" onclick="iniciarApp()">ENTRAR</button>
        </div>

        <!-- MODAL FRASE -->
        <div id="phraseModal" class="modal">
            <button class="close-modal" onclick="cerrarModal('phraseModal')">‚úñ</button>
            <h2 style="text-align:center; color:var(--secondary); margin-top: 20px;">üé≤ Frase M√°gica</h2>
            <div class="game-card">
                <div id="pEs" class="phrase-es">...</div>
                <div id="pCount" class="countdown" style="display:none;">3</div>
                <div id="pEn" class="phrase-en">...</div>
                <div id="pControls" class="phrase-controls" style="display:none;">
                    <button class="btn-replay" onclick="repetirAudio()">üîÅ</button>
                    <button class="btn-next" onclick="siguienteFrase()">Siguiente ‚û°</button>
                </div>
            </div>
        </div>

        <!-- APP CONTENT -->
        <div class="scroll-content">
            
            <div class="mode-switcher">
                <button id="btnKids" class="switch-btn active-kids" onclick="setMode('kids')">ü¶Ñ NI√ëOS</button>
                <button id="btnAdult" class="switch-btn" onclick="setMode('adult')">üëî ADULTOS</button>
            </div>

            <div class="header">
                <h1>Magic School</h1>
                <div class="score-pill">‚≠ê <span id="puntos">0</span></div>
            </div>

            <div class="stats-row">
                <div class="stat-oval">
                    <span class="stat-title">RACHA</span>
                    <span class="stat-value" id="streakVal">1 üî•</span>
                </div>
                <div class="stat-oval">
                    <span class="stat-title">PROGRESO</span>
                    <span class="stat-value" id="progressVal">0%</span>
                </div>
                <div class="stat-oval">
                    <span class="stat-title">ETAPA</span>
                    <span class="stat-value" id="stageVal">1</span>
                </div>
            </div>

            <div class="games-bar">
                <button class="game-btn-purple" onclick="abrirReto()">
                    <span class="game-icon">üó£Ô∏è</span><span class="game-label">Reto</span>
                </button>
                <button class="game-btn-pink" onclick="abrirFrase()">
                    <span class="game-icon">üé≤</span><span class="game-label">Frase</span>
                </button>
                <button class="game-btn-green" onclick="iniciarFutbol()">
                    <span class="game-icon">‚öΩ</span><span class="game-label">F√∫tbol</span>
                </button>
                <button class="game-btn-blue" onclick="borrar()">
                    <span class="game-icon">üßπ</span><span class="game-label">Borrar</span>
                </button>
            </div>

            <div class="input-box">
                <textarea id="entrada" placeholder="Escribe o toca un icono..."></textarea>
                <button class="mic-btn" id="btnMic" onclick="activarMicro()">üé§</button>
            </div>

            <button class="btn-translate" onclick="traducir()">‚ú® TRADUCIR</button>

            <div id="resultado" class="result-compact">
                <span id="resEs">...</span>
                <span class="res-divider">‚îÄ‚îÄ</span>
                <span id="resEn" style="font-weight:900;">...</span>
                <button onclick="repetir()" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üîä</button>
            </div>

            <div class="learning-zone">
                <div class="tabs">
                    <button class="tab-btn active" onclick="loadCat('greetings', this)"><span class="tab-icon">üëã</span><span class="tab-label">Saludos</span></button>
                    <button class="tab-btn" onclick="loadCat('abc', this)"><span class="tab-icon">üî§</span><span class="tab-label">ABC</span></button>
                    <button class="tab-btn" onclick="loadCat('routines', this)"><span class="tab-icon">üìÖ</span><span class="tab-label">Rutinas</span></button>
                    <button class="tab-btn" onclick="loadCat('numbers', this)"><span class="tab-icon">1Ô∏è‚É£</span><span class="tab-label">N√∫meros</span></button>
                    <button class="tab-btn" onclick="loadCat('colors', this)"><span class="tab-icon">üé®</span><span class="tab-label">Colores</span></button>
                    <button class="tab-btn" onclick="loadCat('animals', this)"><span class="tab-icon">ü¶Å</span><span class="tab-label">Animales</span></button>
                    <button class="tab-btn" onclick="loadCat('fruits', this)"><span class="tab-icon">üçé</span><span class="tab-label">Frutas</span></button>
                </div>

                <div class="pagination">
                    <button class="nav-btn" onclick="changePage(-1)">‚¨Ö</button>
                    <span id="pageInfo" style="font-weight:bold; color:#555;">P√°g 1</span>
                    <button class="nav-btn" onclick="changePage(1)">‚û°</button>
                </div>

                <div id="vocabGrid" class="vocab-grid"></div>
            </div>

        </div>
    </div>

    <!-- MODALES -->
    
    <!-- F√öTBOL -->
    <div id="soccerModal" class="modal">
        <button class="close-modal" onclick="cerrarModal('soccerModal')">‚úñ</button>
        <h2 style="text-align:center; color:var(--primary);">‚öΩ Penalty English</h2>
        <div class="soccer-field">
            <div class="goal"></div>
            <div class="goalkeeper" id="goalkeeper">üß§</div>
            <div class="ball" id="ball">‚öΩ</div>
        </div>
        <p id="soccerQ" style="text-align:center; font-size:1.2rem; font-weight:bold; margin:10px 0;">...</p>
        <div class="soccer-options" id="soccerOpts"></div>
    </div>

    <!-- RETO ACTUALIZADO (Con botones Escuchar y Siguiente) -->
    <div id="challengeModal" class="modal">
        <button class="close-modal" onclick="cerrarModal('challengeModal')">‚úñ</button>
        <h2 style="text-align:center; color:var(--accent);">üó£Ô∏è Escucha y Repite</h2>
        <div class="game-card">
            <div id="cWord" style="font-size:2.5rem; font-weight:900; color:#333; margin-bottom:10px;">Cat</div>
            <p id="cStatus" style="color:#666;">Toca el micro y repite</p>
            
            <div class="reto-controls">
                <button class="btn-listen" onclick="escucharReto()">üîä</button>
                <button class="btn-mic-big" onclick="activarReto()">üé§</button>
                <button class="btn-skip" onclick="siguienteReto()">‚û°</button>
            </div>
        </div>
    </div>

    <script>
        let puntos = parseInt(localStorage.getItem('pts')) || 0;
        let racha = parseInt(localStorage.getItem('streak')) || 1;
        let page = 0;
        let cat = 'greetings';
        let currentEn = "";
        let playedPhrases = [];
        let currentPhrase = null;
        let isAdultMode = false;
        let currentChallengeWord = ""; // Para el reto

        const createItems = (base) => {
            let res = [];
            while(res.length < 50) res = res.concat(base);
            return res.slice(0, 50);
        };

        const baseDB = {
            greetings: [{i:'üëã',w:'Hello',e:'Hola'},{i:'üö∂',w:'Goodbye',e:'Adi√≥s'},{i:'üåÖ',w:'Good Morning',e:'Buenos d√≠as'},{i:'üåô',w:'Good Night',e:'Buenas noches'},{i:'üôè',w:'Thank you',e:'Gracias'}],
            routines: [{i:'ü•±',w:'Wake up',e:'Despertar'},{i:'üöø',w:'Shower',e:'Ducha'},{i:'üè´',w:'School',e:'Escuela'},{i:'üõå',w:'Sleep',e:'Dormir'}],
            colors: [{i:'üî¥',w:'Red',e:'Rojo'},{i:'üîµ',w:'Blue',e:'Azul'},{i:'üü¢',w:'Green',e:'Verde'},{i:'üü°',w:'Yellow',e:'Amarillo'}],
            animals: [{i:'üê∂',w:'Dog',e:'Perro'},{i:'üê±',w:'Cat',e:'Gato'},{i:'ü¶Å',w:'Lion',e:'Le√≥n'},{i:'üêò',w:'Elephant',e:'Elefante'}],
            fruits: [{i:'üçé',w:'Apple',e:'Manzana'},{i:'üçå',w:'Banana',e:'Pl√°tano'},{i:'üçá',w:'Grapes',e:'Uvas'},{i:'üçä',w:'Orange',e:'Naranja'}],
            abc: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").map(l => ({i:l, w:l, e:`Letra ${l}`}))
        };

        const db = {
            greetings: createItems(baseDB.greetings),
            routines: createItems(baseDB.routines),
            colors: createItems(baseDB.colors),
            animals: createItems(baseDB.animals),
            fruits: createItems(baseDB.fruits),
            abc: createItems(baseDB.abc)
        };

        const phrasesDB = [
            {es:"El gato es negro", en:"The cat is black"}, 
            {es:"Me gusta el helado", en:"I like ice cream"},
            {es:"Hola amigo", en:"Hello friend"},
            {es:"El sol es amarillo", en:"The sun is yellow"}
        ];

        window.onload = function() {
            updateStats();
            loadCat('greetings', document.querySelector('.tab-btn'));
        };

        function iniciarApp() {
            let msg = new SpeechSynthesisUtterance("Bienvenido a Magic School");
            msg.lang = 'es-ES';
            window.speechSynthesis.speak(msg);
            document.getElementById('welcomeScreen').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('puntos').innerText = puntos;
            let stage = Math.floor(puntos / 100) + 1;
            document.getElementById('stageVal').innerText = stage;
            let progress = puntos % 100;
            document.getElementById('progressVal').innerText = progress + "%";
            document.getElementById('streakVal').innerText = racha + " üî•";
            localStorage.setItem('pts', puntos);
        }

        function loadCat(category, btn) {
            if(btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            cat = category;
            page = 0;
            renderGrid();
        }

        function changePage(dir) {
            page += dir;
            if(page < 0) page = 0;
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('vocabGrid');
            grid.innerHTML = '';
            
            let items = [];
            if(cat === 'numbers') items = getNumbers(page);
            else {
                let list = db[cat];
                let start = page * 10;
                if(start >= list.length) { page = 0; start = 0; }
                items = list.slice(start, start + 10);
            }

            document.getElementById('pageInfo').innerText = `P√°g ${page + 1}`;

            items.forEach(item => {
                let div = document.createElement('div');
                div.className = 'vocab-item';
                div.innerHTML = item.i;
                div.onclick = () => showResult(item.w, item.e);
                grid.appendChild(div);
            });
        }

        function getNumbers(p) {
            let start = p * 10 + 1;
            let res = [];
            for(let i=start; i<start+10; i++) {
                res.push({i:i, w:i.toString(), e:i.toString()}); 
            }
            return res;
        }

        function showResult(en, es) {
            document.getElementById('entrada').value = en;
            let rBox = document.getE

