<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA CONFIG -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#212121">
    <title>Magic School Ultimate</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Fredoka:wght@400;600&display=swap');

        :root {
            /* APP COLORS */
            --bg-body: #00bcd4;
            --primary: #58cc02;
            --secondary: #ff9600;
            --accent: #ce82ff;
            --font-main: 'Fredoka', sans-serif;
            
            /* CRUCIGRAMA DARK */
            --cw-bg: #121212;
            --cw-cell: #eee;
            --cw-highlight: #90CAF9;
            --cw-selected: #FFEB3B;
        }

        body {
            font-family: var(--font-main);
            background: #00bcd4;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .app-shell {
            width: 100%; max-width: 420px; height: 100%;
            background: #f5f5f5; 
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }

        /* --- UI PRINCIPAL --- */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: white; border-bottom: 2px solid #ddd; }
        .logo { margin: 0; color: #6200ea; font-size: 1.4rem; }
        .stats { display: flex; gap: 8px; font-weight: bold; font-size: 0.9rem; }
        .stat-box { background: #FFD700; padding: 4px 10px; border-radius: 12px; border: 2px solid #ffca28; color: #e65100; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }

        /* TRADUCTOR TEXTO */
        .translator-card { background: white; border-radius: 15px; padding: 10px; border: 2px solid #b3e5fc; }
        .trans-input { width: 100%; border: none; font-size: 1.2rem; outline: none; border-bottom: 2px solid #eee; text-align: center; color: #333; font-family: 'Roboto', sans-serif;}
        .btn-trans { width: 100%; background: #039be5; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 5px; cursor: pointer; }

        /* TRADUCTOR DE VOZ */
        .voice-bar {
            background: linear-gradient(135deg, #1565c0, #1e88e5);
            border-radius: 15px; padding: 15px; text-align: center;
            color: white; box-shadow: 0 4px 10px rgba(21, 101, 192, 0.4);
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .voice-title { font-size: 1rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .voice-controls { display: flex; width: 100%; justify-content: space-between; align-items: center; gap: 5px; }
        .lang-select { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 5px; border-radius: 10px; font-weight: bold; font-size: 0.85rem; outline: none; flex: 1; text-align: center; }
        .lang-select option { color: #333; }
        .voice-icon { background: white; color: #1565c0; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; margin-top: 10px; }
        .voice-icon:active { transform: scale(0.9); }
        .voice-icon.listening { background: #f44336; color: white; animation: pulse 1s infinite; }
        .voice-text { font-size: 0.9rem; font-weight: bold; min-height: 1.2em; margin-top: 5px; }

        /* MEN√ö SUPERIOR */
        .menu-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .menu-btn { background: white; border-radius: 15px; padding: 5px; text-align: center; cursor: pointer; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 0 #e0e0e0; border: 2px solid #eee; }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-icon { font-size: 2.2rem; margin-bottom: 5px; }
        .menu-label { font-size: 0.7rem; font-weight: bold; color: #555; }

        /* CATEGOR√çAS */
        .categories-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 20px; }
        .cat-card { background: white; border-radius: 15px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; border-bottom: 4px solid #eee; }
        .cat-card:active { transform: translateY(4px); border-bottom: 2px solid #eee; }
        .cat-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .cat-title { font-size: 0.75rem; font-weight: bold; color: #444; text-transform: uppercase; }
        .c-blue { border-bottom-color: #42a5f5; } .c-green { border-bottom-color: #66bb6a; } .c-orange { border-bottom-color: #ffa726; } .c-purple { border-bottom-color: #ab47bc; } .c-red { border-bottom-color: #ef5350; } .c-teal { border-bottom-color: #26a69a; }

        /* BIENVENIDA */
        #welcomeScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.5s ease; }
        .photo-frame img { width: 120px; }
        .start-btn { background: var(--primary); color: white; padding: 15px 50px; border-radius: 30px; font-size: 1.2rem; border: none; font-weight: bold; margin-top: 20px; cursor: pointer; box-shadow: 0 5px 0 #46a302; }
        .name-input { margin-top: 20px; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.2rem; text-align: center; width: 70%; font-family: 'Roboto', sans-serif;}

        /* MODALES */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 150; display: none; flex-direction: column; animation: slideUp 0.3s ease; }
        .modal-header { background: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #444; text-transform: uppercase; }
        .back-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* PERFIL Y PREMIOS */
        .profile-card { background: white; width: 90%; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .profile-avatar { font-size: 4rem; margin-bottom: 10px; }
        .profile-name { font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .profile-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .p-stat { background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .p-val { font-size: 1.2rem; font-weight: bold; color: var(--secondary); display: block; }
        .p-lbl { font-size: 0.8rem; color: #777; }
        .rewards-box { margin-top: 20px; text-align: left; width: 100%; }
        .reward-item { background: #fff8e1; padding: 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.9rem; border: 1px solid #ffe082; display:flex; align-items:center; gap:10px;}
        .reward-item.locked { opacity: 0.5; filter: grayscale(1); }

        /* CRUCIGRAMA PRO */
        .cw-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 200; display: none; flex-direction: column; }
        .cw-header { padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; background: #212121; color: white; border-bottom: 1px solid #333; height: 50px; flex-shrink: 0; }
        .cw-board-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; background: #121212; position: relative; overflow: auto; }
        .cw-table { display: grid; gap: 2px; background: #000; padding: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid #333; }
        .cw-cell { width: 36px; height: 36px; background: var(--cw-cell); position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 900; text-transform: uppercase; color: #222; }
        .cw-cell.black { background: transparent; pointer-events: none; }
        .cw-cell.active-word { background: var(--cw-highlight) !important; color: #000; }
        .cw-cell.selected { background: var(--cw-selected) !important; color: #000; z-index: 10; box-shadow: inset 0 0 0 2px #000; transform: scale(1.1); }
        .cw-num { position: absolute; top: 1px; left: 2px; font-size: 0.5rem; color: #444; font-weight: bold; line-height: 1; pointer-events: none; }
        .cw-clue-box { background: #263238; border-left: 6px solid #4FC3F7; padding: 15px; min-height: 80px; display: flex; flex-direction: column; justify-content: center; position: relative; flex-shrink: 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); margin: 10px; border-radius: 4px; }
        .cw-clue-text { color: white; font-size: 1rem; font-weight: 500; margin-left: 10px; line-height: 1.2; }
        .fab-check { position: absolute; bottom: 130px; right: 20px; background: #58cc02; color: white; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 2rem; box-shadow: 0 6px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .cw-pack-grid { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; overflow-y: auto; background: #212121; height: 100%; }
        .cw-pack-card { background: #333; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; border-bottom: 4px solid #111; min-height: 120px; }
        .cw-pack-info { padding: 12px; color: white; }

        /* F√öTBOL PRO */
        .soccer-container { text-align: center; width: 100%; }
        .soccer-bg { background: #43a047; height: 200px; border-radius: 15px; position: relative; margin-bottom: 15px; border: 3px solid white; overflow: hidden; }
        .goal-area { width: 60%; height: 60px; border: 6px solid white; border-bottom: none; position: absolute; left: 20%; top: 0; }
        .keeper { font-size: 4rem; position: absolute; top: 40px; left: 42%; transition: 0.4s; }
        .ball-pro { font-size: 3rem; position: absolute; bottom: 10px; left: 45%; transition: 0.6s; z-index: 5; }
        .soccer-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .soccer-btn { background: #0277bd; color: white; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; border: none; font-size: 1.1rem; box-shadow: 0 4px 0 #01579b; }
        .soccer-btn:active { transform: translateY(4px); box-shadow: none; }

        /* MEMORIA PRO */
        .mem-pro-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; width: 100%; margin-top: 10px; }
        .mem-pro-card { aspect-ratio: 1; background: #29b6f6; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 0; color: transparent; transition: transform 0.3s; box-shadow: 0 3px 0 #0288d1; }
        .mem-pro-card.flipped { background: white; color: #333; font-size: 1.2rem; transform: rotateY(180deg); font-weight: bold; border: 2px solid #29b6f6; }
        .mem-pro-card.matched { visibility: hidden; }

        /* GLOBOS (DROP) */
        .balloon-area { height: 300px; background: #e1f5fe; border-radius: 15px; position: relative; overflow: hidden; border: 2px solid #81d4fa; margin-bottom: 10px; }
        .balloon { position: absolute; width: 60px; height: 70px; background: #ff4081; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; font-size: 0.9rem; cursor: pointer; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2); }
        .balloon::after { content:''; position: absolute; bottom: -5px; left: 28px; width: 4px; height: 10px; background: #333; }

        /* LISTAS & OTROS */
        .game-select-card { width: 100%; background: white; padding: 20px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border-left: 8px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .vocab-item { background: white; border-radius: 15px; padding: 10px; text-align: center; box-shadow: 0 4px 0 #ddd; border: 1px solid #eee; cursor: pointer; aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .cat-detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; }
        .quiz-container { width: 100%; display: flex; flex-direction: column; height: 100%; }
        .quiz-option { background: white; border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5; padding: 15px; border-radius: 15px; font-size: 1.2rem; font-weight: bold; color: #4b4b4b; cursor: pointer; text-align: center; margin-bottom: 10px; }
        
        #hiddenInput { position: absolute; opacity: 0; top: -1000px; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

<div class="app-shell">
    
    <!-- LOGIN -->
    <div id="welcomeScreen">
        <div class="photo-frame"><img src="https://cdn-icons-png.flaticon.com/512/4322/4322992.png" style="width:100%"></div>
        <h1 style="color:var(--primary); margin-bottom: 5px;" id="welcomeText">¬°Bienvenido!</h1>
        <p style="color:#777;">Escribe tu nombre:</p>
        <input type="text" id="usernameInput" class="name-input" placeholder="Tu Nombre" maxlength="12">
        <button class="start-btn" onclick="registerUser()">ENTRAR</button>
    </div>

    <!-- HEADER -->
    <div class="header">
        <h2 class="logo">Magic School</h2>
        <div class="stats">
            <div class="stat-box">üî• <span id="userStreak">0</span></div>
            <div class="stat-box">‚≠ê <span id="userPoints">0</span></div>
            <div class="stat-box" style="background:#fff; border:2px solid #ddd; cursor:pointer;" onclick="openProfile()">üë§</div>
        </div>
    </div>

    <div class="scroll-area">
        <!-- TRADUCTOR -->
        <div class="translator-card">
            <input type="text" id="transIn" class="trans-input" placeholder="Escribe (Hola)...">
            <button class="btn-trans" onclick="doTranslate()">TRADUCIR</button>
            <div id="transOut" style="text-align:center; margin-top:5px; font-weight:bold; color:var(--primary);">...</div>
        </div>

        <!-- MEN√ö -->
        <div class="menu-row">
            <div class="menu-btn" style="border-bottom-color:#42a5f5" onclick="openStages()"><div class="menu-icon">üó∫Ô∏è</div><div class="menu-label">Etapas</div></div>
            <div class="menu-btn" style="border-bottom-color:#ef5350" onclick="openCrosswordMenu()"><div class="menu-icon">üß©</div><div class="menu-label">Crucigrama</div></div>
            <div class="menu-btn" style="border-bottom-color:#ab47bc" onclick="openModal('modalChess')"><div class="menu-icon">‚ôüÔ∏è</div><div class="menu-label">L√≥gica</div></div>
            <div class="menu-btn" style="border-bottom-color:#ffca28" onclick="openModal('modalGamesMenu')"><div class="menu-icon">üéÆ</div><div class="menu-label">Juegos</div></div>
        </div>

        <!-- TRADUCTOR VOZ -->
        <div class="voice-bar">
            <div class="voice-title">TRADUCTOR UNIVERSAL üåç</div>
            <div class="voice-controls">
                <select id="sourceLang" class="lang-select"><option value="es-ES">Hablo: Espa√±ol üá™üá∏</option><option value="en-US">Hablo: Ingl√©s üá∫üá∏</option></select>
                <span style="font-size:1.5rem">‚û°</span>
                <select id="targetLang" class="lang-select"><option value="en">A: Ingl√©s üá∫üá∏</option><option value="es">A: Espa√±ol üá™üá∏</option><option value="fr">A: Franc√©s üá´üá∑</option></select>
            </div>
            <div class="voice-icon" id="micBtn" onclick="startVoiceTranslation()">üé§</div>
            <div class="voice-text" id="voiceStatus">Toca y habla...</div>
        </div>

        <!-- CATEGOR√çAS -->
        <div class="categories-grid">
            <div class="cat-card c-blue" onclick="openCategory('verbs', 'Verbos')"><div class="cat-icon">üèÉ</div><div class="cat-title">Verbos</div></div>
            <div class="cat-card c-green" onclick="openCategory('abc', 'Abecedario')"><div class="cat-icon">üî§</div><div class="cat-title">Abecedario</div></div>
            <div class="cat-card c-orange" onclick="openCategory('greetings', 'Saludos')"><div class="cat-icon">üëã</div><div class="cat-title">Saludos</div></div>
            <div class="cat-card c-purple" onclick="openCategory('animals', 'Animales')"><div class="cat-icon">üê∂</div><div class="cat-title">Animales</div></div>
            <div class="cat-card c-red" onclick="openCategory('routines', 'Rutina')"><div class="cat-icon">üìÖ</div><div class="cat-title">Rutina</div></div>
            <div class="cat-card c-teal" onclick="openCategory('fruits', 'Frutas')"><div class="cat-icon">üçé</div><div class="cat-title">Frutas</div></div>
            <div class="cat-card c-blue" onclick="openCategory('food', 'Comida')"><div class="cat-icon">üçî</div><div class="cat-title">Comida</div></div>
            <div class="cat-card c-green" onclick="openCategory('numbers', 'N√∫meros')"><div class="cat-icon">1Ô∏è‚É£</div><div class="cat-title">N√∫meros</div></div>
            <div class="cat-card c-purple" onclick="openCategory('family', 'Familia')"><div class="cat-icon">üë™</div><div class="cat-title">Familia</div></div>
        </div>
    </div>
</div>

<!-- ================= MODALES ================= -->

<!-- PERFIL -->
<div id="modalProfile" class="modal-overlay">
    <div class="modal-header"><button class="back-btn" onclick="closeModal('modalProfile')">‚¨Ö</button><h3>Mi Perfil</h3><div></div></div>
    <div class="modal-body">
        <div class="profile-card">
            <div class="profile-avatar">üéì</div>
            <div class="profile-name" id="profileName">Estudiante</div>
            <div class="profile-stats">
                <div class="p-stat"><span class="p-val" id="pStreak">0</span><span class="p-lbl">Racha</span></div>
                <div class="p-stat"><span class="p-val" id="pPoints">0</span><span class="p-lbl">Puntos</span></div>
            </div>
            <div class="rewards-box" id="rewardsList">
                <!-- Premios -->
            </div>
        </div>
    </div>
</div>

<!-- OTROS -->
<div id="modalCategory" class="modal-overlay"><div class="modal-header"><button class="back-btn" onclick="closeModal('modalCategory')">‚¨Ö</button><span class="modal-title" id="catTitle">...</span><div></div></div><div class="modal-body"><div class="cat-detail-grid" id="catGrid"></div></div></div>

<!-- CRUCIGRAMA -->
<div id="packsScreen" class="cw-screen"><div class="cw-header"><button class="cw-close-btn" onclick="closePacks()">‚¨Ö</button><span>NIVELES</span><div></div></div><div class="cw-pack-grid" id="packsGrid"></div></div>
<div id="gameScreen" class="cw-screen" style="z-index:250"><div class="cw-header"><button class="cw-close-btn" onclick="closeGame()">‚úñ</button><span id="gameTitle">Nivel</span><div></div></div><div class="cw-board-area"><div id="gridTable" class="cw-table"></div></div><button class="fab-check" onclick="checkCrossword()">‚úì</button><div class="cw-clue-box"><div class="cw-clue-text" id="currentClueDisplay">...</div></div><input type="text" id="hiddenInput" autocomplete="off"></div>

<!-- JUEGOS HUB -->
<div id="modalGamesMenu" class="modal-overlay">
    <div class="modal-header"><button class="back-btn" onclick="closeModal('modalGamesMenu')">‚¨Ö</button><h3>Arcade Pro</h3><div></div></div>
    <div class="modal-body">
        <div class="game-select-card" style="border-left:8px solid #0288d1" onclick="initSoccerPro()"><div><b>‚öΩ F√∫tbol Pro</b><br><small>Goles y Vidas</small></div><div style="font-size:2.5rem">ü•Ö</div></div>
        <div class="game-select-card" style="border-left:8px solid #fbc02d" onclick="initGlobos()"><div><b>üéà Globos (Drop)</b><br><small>Atrapa la palabra</small></div><div style="font-size:2.5rem">üéà</div></div>
        <div class="game-select-card" style="border-left:8px solid #ef5350" onclick="initMemoryPro()"><div><b>üß† Memoria Pro</b><br><small>Parejas Ingl√©s-Espa√±ol</small></div><div style="font-size:2.5rem">üÉè</div></div>
    </div>
</div>

<!-- JUEGO F√öTBOL PRO -->
<div id="modalSoccer" class="modal-overlay"><div class="modal-header"><button class="back-btn" onclick="closeModal('modalSoccer')">‚¨Ö</button><h3>F√∫tbol Pro</h3><div></div></div><div class="modal-body"><div style="text-align:center; width:100%;"><h3>Vidas: <span id="socLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></h3><div class="soccer-field"><div class="goal-post"></div><div class="goalkeeper" id="keeper">üß§</div><div class="ball" id="ball">‚öΩ</div></div><h2 id="socQ">...</h2><div id="socBtns" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div></div></div></div>

<!-- JUEGO GLOBOS -->
<div id="modalGlobos" class="modal-overlay"><div class="modal-header"><button class="back-btn" onclick="closeModal('modalGlobos')">‚¨Ö</button><h3>Globos</h3><div></div></div><div class="modal-body"><h3 id="dropTarget" style="text-align:center;">Traduce: GATO</h3><div class="balloon-area" id="balloonArea"></div></div></div>

<!-- JUEGO MEMORIA PRO -->
<div id="modalMemory" class="modal-overlay"><div class="modal-header"><button class="back-btn" onclick="closeModal('modalMemory')">‚¨Ö</button><h3>Memoria Pro</h3><div></div></div><div class="modal-body"><div id="memProGrid" class="mem-pro-grid"></div></div></div>

<script>
    // --- USUARIO & PREMIOS ---
    let currentUser = JSON.parse(localStorage.getItem('magicUser')) || null;
    const rewards = [
        {id:1, name:"Bronce", req:3}, {id:2, name:"Plata", req:7}, {id:3, name:"Oro", req:15}
    ];

    window.onload = () => {
        if(currentUser) { checkStreak(); loadInterface(); }
        else { document.getElementById('welcomeScreen').style.transform = "translateY(0)"; }
        window.speechSynthesis.getVoices();
    };

    function registerUser() {
        const name = document.getElementById('usernameInput').value.trim();
        if(!name) return;
        currentUser = { name: name, points: 0, streak: 0, lastLogin: new Date().toDateString() };
        localStorage.setItem('magicUser', JSON.stringify(currentUser));
        loadInterface();
    }

    function checkStreak() {
        const today = new Date().toDateString();
        if(currentUser.lastLogin !== today) {
            const last = new Date(currentUser.lastLogin);
            const now = new Date();
            const diff = (now - last) / (1000 * 60 * 60 * 24);
            if(diff < 2) currentUser.streak++; else currentUser.streak = 1;
            currentUser.lastLogin = today;
            saveUser();
        }
    }

    function openProfile() {
        document.getElementById('profileName').innerText = currentUser.name;
        document.getElementById('pPoints').innerText = currentUser.points;
        document.getElementById('pStreak').innerText = currentUser.streak;
        
        const rList = document.getElementById('rewardsList'); rList.innerHTML = '';
        rewards.forEach(r => {
            let d = document.createElement('div');
            d.className = currentUser.streak >= r.req ? 'reward-item' : 'reward-item locked';
            d.innerHTML = `<div>${currentUser.streak >= r.req ? 'üèÜ' : 'üîí'}</div><div><b>Medalla ${r.name}</b><br><small>${r.req} d√≠as seguidos</small></div>`;
            rList.appendChild(d);
        });
        openModal('modalProfile');
    }

    function loadInterface() {
        document.getElementById('welcomeScreen').style.transform = "translateY(-100%)";
        document.getElementById('userPoints').innerText = currentUser.points;
        document.getElementById('userStreak').innerText = currentUser.streak;
        speak("");
    }
    function saveUser(){ localStorage.setItem('magicUser', JSON.stringify(currentUser)); }
    function addPts(n){ currentUser.points += n; saveUser(); document.getElementById('userPoints').innerText = currentUser.points; }
    function logout() { localStorage.removeItem('magicUser'); location.reload(); }
    
    // --- TRADUCTOR ---
    let isRec = false, rec = null;
    async function doTranslate() {
        const txt = document.getElementById('transIn').value;
        if(!txt) return;
        const src = document.getElementById('sourceLang').value.split('-')[0];
        const tgt = document.getElementById('targetLang').value;
        try {
            const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${src}&tl=${tgt}&dt=t&q=${encodeURIComponent(txt)}`);
            const j = await r.json();
            document.getElementById('transOut').innerText = j[0][0][0];
            speak(j[0][0][0], getVoiceLang(tgt));
        } catch(e) {}
    }
    function startVoiceTranslation() {
        if(isRec) { if(rec) rec.stop(); resetMic(); return; }
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!Speech) return;
        rec = new Speech(); rec.lang = document.getElementById('sourceLang').value;
        const mic = document.getElementById('micBtn');
        mic.classList.add('listening'); document.getElementById('voiceStatus').innerText = "Escuchando..."; isRec = true;
        rec.onresult = (e) => { translateAndSpeak(e.results[0][0].transcript, document.getElementById('targetLang').value); };
        rec.onend = resetMic;
        try{rec.start();}catch(e){resetMic();}
    }
    function resetMic(){ isRec=false; document.getElementById('micBtn').classList.remove('listening'); document.getElementById('voiceStatus').innerText="..."; }
    async function translateAndSpeak(txt, tgt) {
        const src = document.getElementById('sourceLang').value.split('-')[0];
        const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${src}&tl=${tgt}&dt=t&q=${encodeURIComponent(txt)}`);
        const j = await r.json(); const res = j[0][0][0];
        document.getElementById('voiceStatus').innerText = `${txt} ‚ûù ${res}`;
        speak(res, getVoiceLang(tgt));
    }
    function getVoiceLang(c){ const m={en:'en-US',es:'es-ES',fr:'fr-FR',it:'it-IT',pt:'pt-BR'}; return m[c]||'en-US'; }
    function speak(t, l='en-US'){ window.speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(t); u.lang=l; u.rate=0.9; window.speechSynthesis.speak(u); }
    function openModal(id){document.getElementById(id).style.display='flex';}
    function closeModal(id){document.getElementById(id).style.display='none';}

    // --- DB & GAMES DATA ---
    const db = {
        greetings: [{i:'üëã',e:'Hello',s:'Hola'},{i:'üö∂',e:'Bye',s:'Adi√≥s'},{i:'üåÖ',e:'Good Morning',s:'Buenos d√≠as'}],
        abc: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').map(l=>({i:l,e:l,s:l})),
        animals: [{i:'üê∂',e:'Dog',s:'Perro'},{i:'üê±',e:'Cat',s:'Gato'},{i:'ü¶Å',e:'Lion',s:'Le√≥n'}],
        fruits: [{i:'üçé',e:'Apple',s:'Manzana'},{i:'üçå',e:'Banana',s:'Pl√°tano'}],
        food: [{i:'üçï',e:'Pizza',s:'Pizza'},{i:'üçî',e:'Burger',s:'Hamburguesa'}],
        colors: [{i:'üî¥',e:'Red',s:'Rojo'},{i:'üîµ',e:'Blue',s:'Azul'}],
        routines: [{i:'ü•±',e:'Wake up',s:'Despertar'},{i:'üöø',e:'Shower',s:'Ducha'}],
        family: [{i:'üë®',e:'Father',s:'Pap√°'},{i:'üë©',e:'Mother',s:'Mam√°'}],
        numbers: [{i:'1Ô∏è‚É£',e:'One',s:'1'},{i:'2Ô∏è‚É£',e:'Two',s:'2'}],
        home: [{i:'üè†',e:'House',s:'Casa'},{i:'üö™',e:'Door',s:'Puerta'}],
        body: [{i:'üëÄ',e:'Eyes',s:'Ojos'},{i:'üëÉ',e:'Nose',s:'Nariz'}],
        school: [{i:'‚úèÔ∏è',e:'Pencil',s:'L√°piz'},{i:'üìñ',e:'Book',s:'Libro'}],
        verbs: [{i:'üèÉ',e:'Run',s:'Correr'},{i:'üèä',e:'Swim',s:'Nadar'}]
    };

    // --- CATEGORY ---
    function openCategory(c, t){
        document.getElementById('catTitle').innerText=t; const g=document.getElementById('catGrid'); g.innerHTML='';
        if(db[c]) db[c].forEach(i=>{let d=document.createElement('div'); d.className='vocab-item'; d.innerHTML=`<div class="v-icon">${i.i}</div><div class="v-word">${i.s}</div>`; d.onclick=()=>speak(i.e); g.appendChild(d);});
        openModal('modalCategory');
    }

    // --- FUTBOL PRO ---
    let socLives = 3;
    function initSoccerPro() {
        socLives = 3; updateSocLives();
        openModal('modalSoccer');
        newKick();
    }
    function updateSocLives() {
        let h = ""; for(let i=0;i<socLives;i++) h+="‚ù§Ô∏è";
        document.getElementById('socLives').innerText = h;
    }
    function newKick() {
        if(socLives<=0) { alert("Game Over"); closeModal('modalSoccer'); return; }
        document.getElementById('ball').style.bottom="10px";
        
        const all = [...db.animals, ...db.fruits];
        const q = all[Math.floor(Math.random()*all.length)];
        const w = all[Math.floor(Math.random()*all.length)];
        
        document.getElementById('socQ').innerText = q.s;
        const btns = [
            `<button class="game-btn" onclick="kickPro(true, '${q.e}')">${q.e}</button>`,
            `<button class="game-btn" style="background:#ff9100" onclick="kickPro(false)">${w.e}</button>`
        ].sort(()=>Math.random()-0.5).join('');
        
        document.getElementById('socBtns').innerHTML = btns;
    }
    function kickPro(win, w) {
        if(win) {
            document.getElementById('ball').style.bottom="180px";
            document.getElementById('keeper').style.left="80%";
            speak("Goal! "+w); addPts(20);
        } else {
            document.getElementById('keeper').style.left="45%";
            speak("Missed"); socLives--; updateSocLives();
        }
        setTimeout(newKick, 1500);
    }

    // --- GLOBOS (DROP) ---
    let dropInterval;
    function initGlobos() {
        openModal('modalGlobos');
        const area = document.getElementById('balloonArea');
        area.innerHTML = '';
        
        const all = [...db.colors, ...db.numbers];
        const target = all[Math.floor(Math.random()*all.length)];
        document.getElementById('dropTarget').innerText = "Traduce: " + target.s;
        
        const opts = [target, all[Math.floor(Math.random()*all.length)]];
        
        opts.forEach((o, i) => {
            let b = document.createElement('div');
            b.className = "balloon";
            b.innerText = o.e;
            b.style.left = (i*50 + 20) + "%";
            b.style.top = "0px";
            b.onclick = () => {
                if(o.e === target.e) { speak("Correct!"); addPts(10); clearInterval(dropInterval); setTimeout(initGlobos, 1000); }
                else { speak("Wrong"); b.style.display='none'; }
            };
            area.appendChild(b);
        });
        
        let pos = 0;
        dropInterval = setInterval(() => {
            pos += 2;
            document.querySelectorAll('.balloon').forEach(b => b.style.top = pos + "px");
            if(pos > 250) { clearInterval(dropInterval); setTimeout(initGlobos, 500); }
        }, 50);
    }

    // --- MEMORIA PRO ---
    let mSel = [];
    function initMemoryPro() {
        openModal('modalMemory');
        const g = document.getElementById('memProGrid'); g.innerHTML = '';
        const items = [...db.animals, ...db.fruits].sort(()=>Math.random()-0.5).slice(0, 6);
        let cards = [];
        items.forEach(i => {
            cards.push({id:i.e, content:i.i, type:'img'});
            cards.push({id:i.e, content:i.e, type:'txt'});
        });
        cards.sort(()=>Math.random()-0.5);
        
        cards.forEach(c => {
            let div = document.createElement('div');
            div.className = 'mem-pro-card';
            div.onclick = () => {
                if(mSel.length < 2 && !div.classList.contains('flipped')) {
                    div.classList.add('flipped'); div.innerText = c.content;
                    mSel.push({el:div, id:c.id});
                    if(mSel.length === 2) checkMemPro();
                }
            };
            g.appendChild(div);
        });
    }
    function checkMemPro() {
        if(mSel[0].id === mSel[1].id) {
            speak("Match!"); addPts(15);
            mSel[0].el.classList.add('matched'); mSel[1].el.classList.add('matched');
            mSel = [];
        } else {
            setTimeout(() => {
                mSel[0].el.classList.remove('flipped'); mSel[0].el.innerText = "";
                mSel[1].el.classList.remove('flipped'); mSel[1].el.innerText = "";
                mSel = [];
            }, 1000);
        }
    }

    // --- CRUCIGRAMA (Mantenido) ---
    const packs=[{id:0,title:"B√°sico",diff:"F√°cil",s:3,l:[['R','E','D'],['#','#','O'],['#','#','G']],c:["Color sangre","Animal ladra"],sol:{'0-0':'R','0-1':'E','0-2':'D','1-2':'O','2-2':'G'}}];
    let curPack, selCell, curDir='H', grState=[];
    function openCrosswordMenu(){openModal('packsScreen'); let g=document.getElementById('packsGrid'); g.innerHTML=''; packs.forEach(p=>{let d=document.createElement('div'); d.className='cw-pack-card'; d.innerHTML=`<div class="cw-pack-info">${p.title}</div>`; d.onclick=()=>loadCw(p); g.appendChild(d);});}
    function closePacks(){closeModal('packsScreen');} function closeGame(){closeModal('gameScreen');}
    function loadCw(p){curPack=p; document.getElementById('gameTitle').innerText=p.title; openModal('gameScreen'); buildCw(p);}
    function buildCw(p){const b=document.getElementById('gridTable'); b.style.gridTemplateColumns=`repeat(${p.s},1fr)`; b.innerHTML=''; grState=[]; for(let r=0;r<p.s;r++){let row=[]; for(let c=0;c<p.s;c++){let ch=p.l[r][c]; let d=document.createElement('div'); if(ch==='#')d.className='cw-cell black'; else {d.className='cw-cell'; let i=document.createElement('input'); i.className='trans-input'; i.style.background='transparent'; i.maxLength=1; i.dataset.r=r; i.dataset.c=c; i.onfocus=()=>selCw(r,c); i.onkeyup=(e)=>inpCw(e,i); d.appendChild(i);} b.appendChild(d); row.push({el:d,sol:ch});} grState.push(row);}}
    function selCw(r,c){selCell={r,c}; document.getElementById('currentClueDisplay').innerText=curPack.c[0];}
    function inpCw(e,i){if(e.key.match(/[a-z]/i)) i.parentElement.nextElementSibling?.querySelector('input')?.focus();}
    function checkCrossword(){document.querySelectorAll('.cw-cell input').forEach(i=>{let r=i.dataset.r,c=i.dataset.c,s=curPack.sol[`${r}-${c}`]; if(i.value.toUpperCase()===s)i.style.color='green'; else i.style.color='red';});}

</script>
</body>
</html>



