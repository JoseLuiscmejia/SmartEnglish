<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA CONFIG -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#a1c4fd">
    <title>Magic School Pro</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063823.png">

    <style>
        /* IMPORTAR FUENTE POPPINS (M√°s moderna) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');

        :root {
            --primary: #4facfe;
            --primary-dark: #00f2fe;
            --accent: #ff9a9e;
            --text-dark: #3a3a3a;
            --text-light: #777;
            --white: #ffffff;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
            
            /* CRUCIGRAMA DARK MODE (Se mantiene oscuro por contraste) */
            --cw-bg: #1a1a1a;
            --cw-cell: #eee;
            --cw-highlight: #64b5f6;
            --cw-selected: #ffeb3b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--text-dark);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #user-stats {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
        }

        .stat-pill {
            background: #f0f8ff;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--text-dark);
            border: 1px solid #dbeafe;
        }

        /* MAIN CONTENT */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* CARD GEN√âRICA (Estilo Moderno) */
        .modern-card {
            background-color: var(--white);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .modern-card:active { transform: scale(0.98); }

        /* TRADUCTOR */
        .translator-section {
            display: flex; flex-direction: column; gap: 10px;
        }
        .trans-input {
            width: 100%; border: none; font-size: 1.2rem; outline: none;
            border-bottom: 2px solid #eee; text-align: center; color: var(--text-dark);
            padding: 10px; background: transparent; font-weight: 600;
        }
        .trans-btn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white; border: none; padding: 12px; border-radius: 12px;
            font-weight: 600; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4);
        }

        /* MINIJUEGOS (GRID) */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .game-card {
            background: var(--white);
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 130px;
        }
        .game-card:active { transform: translateY(5px); }
        .game-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .game-title { font-weight: 700; color: var(--text-dark); font-size: 0.9rem; }
        .game-desc { font-size: 0.7rem; color: var(--text-light); }

        /* TRADUCTOR DE VOZ (Card Especial) */
        .voice-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; text-align: center;
        }
        .voice-controls {
            display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;
        }
        .lang-select {
            background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 5px 10px; border-radius: 10px; font-weight: 600; outline: none;
        }
        .lang-select option { color: #333; }
        .mic-btn {
            background: white; color: #764ba2; width: 70px; height: 70px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer; transition: 0.2s;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.listening { background: #ff4b4b; color: white; animation: pulse 1s infinite; }

        /* CATEGOR√çAS (Chips/Burbujas) */
        .cat-container {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
        }
        .cat-chip {
            background: var(--white); padding: 10px 20px; border-radius: 25px;
            font-weight: 600; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer; display: flex; align-items: center; gap: 8px; border: 1px solid transparent;
        }
        .cat-chip:active { background: #e0f2f1; transform: scale(0.95); }
        .cat-chip.active { border-color: var(--primary); background: #f0f9ff; }

        /* FOOTER */
        footer {
            background: rgba(255,255,255,0.8);
            text-align: center; padding: 15px;
            font-size: 0.8rem; color: var(--text-light);
            backdrop-filter: blur(10px);
        }

        /* BIENVENIDA */
        #welcomeScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.5s ease; }
        .start-btn { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; padding: 15px 60px; border-radius: 50px; font-size: 1.5rem; border: none; font-weight: bold; margin-top: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4); }

        /* --- MODALES & JUEGOS (Funcionalidad intacta, dise√±o adaptado) --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 150; display: none; flex-direction: column; animation: slideUp 0.3s ease; }
        .modal-header { background: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .modal-title { font-weight: 800; color: var(--text-dark); font-size: 1.2rem; }
        .close-btn { background: #eee; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }

        /* Grid Detalle Categor√≠a */
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .detail-card { background: white; border-radius: 15px; padding: 15px; text-align: center; box-shadow: var(--shadow); cursor: pointer; }
        .detail-card:active { transform: scale(0.95); }

        /* Crucigrama Dark */
        .cw-screen { background: var(--cw-bg); color: white; position: absolute; top:0; left:0; width:100%; height:100%; z-index:200; display:none; flex-direction:column; }
        .cw-header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .cw-grid-area { flex:1; display:flex; justify-content:center; align-items:center; overflow:auto; padding:10px; }
        .cw-table { display:grid; gap:2px; background:#000; padding:2px; border:2px solid #333; }
        .cw-cell { width:38px; height:38px; background:var(--cw-cell); display:flex; justify-content:center; align-items:center; font-weight:900; font-size:1.2rem; color:#111; position:relative; cursor:pointer; }
        .cw-cell.black { background:transparent; pointer-events:none; }
        .cw-cell.active-word { background:var(--cw-highlight) !important; }
        .cw-cell.selected { background:var(--cw-selected) !important; }
        .cw-clue-box { background:#263238; padding:15px; border-top:4px solid #4fc3f7; color:white; text-align:center; }
        .cw-input-hidden { position:absolute; opacity:0; top:-1000px; }

        /* Animaciones */
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .confetti { position: absolute; pointer-events: none; animation: fall 3s linear forwards; z-index: 300; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        
        /* Etapas Duolingo Style */
        .path-container { display: flex; flex-direction: column; align-items: center; gap: 10px; padding-bottom: 40px; }
        .level-node { width: 70px; height: 70px; border-radius: 50%; background: #58cc02; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.8rem; box-shadow: 0 6px 0 #46a302; cursor: pointer; transition: 0.1s; position: relative; z-index: 2; }
        .level-node:active { transform: translateY(4px); box-shadow: 0 2px 0 #46a302; }
        .level-node.locked { background: #e5e5e5; box-shadow: 0 6px 0 #cfcfcf; color: #aaa; pointer-events: none; }
        .path-line { width: 8px; height: 20px; background: #e5e5e5; margin: -5px 0; z-index: 1; }

    </style>
</head>
<body>

<div class="app-shell">
    
    <!-- PANTALLA DE BIENVENIDA -->
    <div id="welcomeScreen">
        <img src="https://cdn-icons-png.flaticon.com/512/4322/4322992.png" width="120" style="margin-bottom:20px">
        <h1 style="color:#333; font-weight:800;">Magic School Pro</h1>
        <p style="color:#777;">Aprende ingl√©s jugando</p>
        <button class="start-btn" onclick="enterApp()">COMENZAR üöÄ</button>
    </div>

    <!-- HEADER -->
    <header>
        <h1>ü¶ä Magic School</h1>
        <div id="user-stats">
            <div class="stat-pill">üî• <span id="streak">1</span></div>
            <div class="stat-pill">‚≠ê <span id="points">0</span></div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
        
        <!-- SECCI√ìN JUEGOS (GRID) -->
        <section class="games-grid">
            <div class="game-card" onclick="openStages()">
                <div class="game-icon">üó∫Ô∏è</div>
                <div class="game-title">Etapas</div>
                <div class="game-desc">Camino de aprendizaje</div>
            </div>
            <div class="game-card" onclick="openCrosswordMenu()">
                <div class="game-icon">üß©</div>
                <div class="game-title">Crucigrama</div>
                <div class="game-desc">Reto de palabras</div>
            </div>
            <div class="game-card" onclick="alert('Pronto m√°s niveles')">
                <div class="game-icon">‚ôüÔ∏è</div>
                <div class="game-title">L√≥gica</div>
                <div class="game-desc">Entrena tu mente</div>
            </div>
            <div class="game-card" onclick="openModal('modalGamesMenu')">
                <div class="game-icon">üéÆ</div>
                <div class="game-title">Arcade</div>
                <div class="game-desc">Minijuegos r√°pidos</div>
            </div>
        </section>

        <!-- TRADUCTOR DE VOZ PRO -->
        <section class="modern-card voice-card">
            <div class="voice-controls">
                <select id="sourceLang" class="lang-select">
                    <option value="es-ES">Hablo Espa√±ol üá™üá∏</option>
                    <option value="en-US">Speak English üá∫üá∏</option>
                </select>
                <span>‚û°</span>
                <select id="targetLang" class="lang-select">
                    <option value="en">Ingl√©s üá∫üá∏</option>
                    <option value="fr">Franc√©s üá´üá∑</option>
                    <option value="it">Italiano üáÆüáπ</option>
                    <option value="de">Alem√°n üá©üá™</option>
                </select>
            </div>
            <div class="mic-btn" id="micBtn" onclick="startVoiceTranslation()">üé§</div>
            <p id="voiceStatus" style="margin-top:15px; font-size:0.9rem; font-weight:600;">Toca y habla...</p>
        </section>

        <!-- CATEGOR√çAS R√ÅPIDAS (CHIPS) -->
        <section>
            <h3 style="color:#555; margin-bottom:15px;">üìö Vocabulario</h3>
            <div class="cat-container">
                <div class="cat-chip" onclick="openCategory('greetings', 'Saludos')">üëã Saludos</div>
                <div class="cat-chip" onclick="openCategory('animals', 'Animales')">üê∂ Animales</div>
                <div class="cat-chip" onclick="openCategory('fruits', 'Frutas')">üçé Frutas</div>
                <div class="cat-chip" onclick="openCategory('colors', 'Colores')">üé® Colores</div>
                <div class="cat-chip" onclick="openCategory('numbers', 'N√∫meros')">1Ô∏è‚É£ N√∫meros</div>
                <div class="cat-chip" onclick="openCategory('family', 'Familia')">üë™ Familia</div>
                <div class="cat-chip" onclick="openCategory('body', 'Cuerpo')">üëÄ Cuerpo</div>
                <div class="cat-chip" onclick="openCategory('verbs', 'Verbos')">üèÉ Verbos</div>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer>
        <p>Magic School Pro ¬© 2025 - Aprende divirti√©ndote</p>
    </footer>

</div>

<!-- ================= MODALES ================= -->

<!-- MODAL CATEGOR√çA -->
<div id="modalCategory" class="modal-overlay">
    <div class="modal-header">
        <button class="close-btn" onclick="closeModal('modalCategory')">‚¨Ö</button>
        <span class="modal-title" id="catTitle">...</span>
        <div style="width:40px"></div>
    </div>
    <div class="modal-body">
        <div class="detail-grid" id="catDetailGrid"></div>
    </div>
</div>

<!-- MODAL MAPA ETAPAS -->
<div id="modalStages" class="modal-overlay">
    <div class="modal-header"><button class="close-btn" onclick="closeModal('modalStages')">‚¨Ö</button><span class="modal-title">TU CAMINO</span><div></div></div>
    <div class="modal-body"><div id="pathContainer" class="path-container"></div></div>
</div>

<!-- MODAL PACKS CRUCIGRAMA -->
<div id="packsScreen" class="cw-screen" style="background:#212121">
    <div class="cw-header"><button class="cw-close-btn" onclick="closePacks()">‚¨Ö</button><span style="font-weight:bold">NIVELES</span><div></div></div>
    <div class="cw-pack-grid" id="packsGrid" style="padding:20px; display:grid; gap:15px;"></div>
</div>

<!-- JUEGO CRUCIGRAMA -->
<div id="gameScreen" class="cw-screen" style="z-index:250">
    <div class="cw-header"><button class="cw-close-btn" onclick="closeGame()">‚úñ</button><span id="gameTitle" style="font-weight:bold">Nivel 1</span><div></div></div>
    <div class="cw-board-area"><div id="gridTable" class="cw-table"></div></div>
    <div class="cw-clue-box">
        <div style="font-size:0.8rem; color:#4fc3f7; font-weight:bold; margin-bottom:5px;">PISTA</div>
        <div id="currentClueDisplay" style="font-size:1.1rem; font-weight:bold;">Selecciona una casilla...</div>
    </div>
    <input type="text" id="hiddenInput" autocomplete="off" class="cw-input-hidden">
</div>

<!-- MODAL QUIZ (EXAMEN) -->
<div id="modalQuiz" class="modal-overlay" style="z-index:300;">
    <div class="modal-header"><button class="close-btn" onclick="closeModal('modalQuiz')">‚úñ</button><h3 style="color:#333">Quiz</h3></div>
    <div class="modal-body" style="display:flex; flex-direction:column; justify-content:center;">
        <h2 id="quizPrompt" style="text-align:center; margin-bottom:30px; color:#333; font-size:1.5rem;">...</h2>
        <div id="quizOptions" style="display:flex; flex-direction:column; gap:15px;"></div>
    </div>
</div>

<!-- MENU JUEGOS EXTRA -->
<div id="modalGamesMenu" class="modal-overlay">
    <div class="modal-header"><button class="close-btn" onclick="closeModal('modalGamesMenu')">‚¨Ö</button><h3>Arcade</h3></div>
    <div class="modal-body" style="display:grid; gap:15px;">
        <div class="game-card" onclick="alert('Pronto')"><div class="game-icon">‚öΩ</div><div class="game-title">F√∫tbol</div></div>
        <div class="game-card" onclick="alert('Pronto')"><div class="game-icon">üß†</div><div class="game-title">Memoria</div></div>
    </div>
</div>

<script>
    let pts = parseInt(localStorage.getItem('pts')) || 0;
    let unlockedLevel = parseInt(localStorage.getItem('unlockedLevel')) || 1;
    let isListening = false, recognition = null;

    const sfx = { correct: new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'), wrong: new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'), win: new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg') };
    function playSfx(t) { if(sfx[t]) { sfx[t].currentTime=0; sfx[t].play().catch(e=>{}); } }

    // --- DATA ---
    const db = {
        greetings: [{i:'üëã',e:'Hello',s:'Hola'},{i:'üö∂',e:'Bye',s:'Adi√≥s'},{i:'üåÖ',e:'Good Morning',s:'Buenos d√≠as'},{i:'üôè',e:'Thank you',s:'Gracias'}],
        animals: [{i:'üê∂',e:'Dog',s:'Perro'},{i:'üê±',e:'Cat',s:'Gato'},{i:'ü¶Å',e:'Lion',s:'Le√≥n'},{i:'üêØ',e:'Tiger',s:'Tigre'},{i:'üêò',e:'Elephant',s:'Elefante'},{i:'üêµ',e:'Monkey',s:'Mono'}],
        fruits: [{i:'üçé',e:'Apple',s:'Manzana'},{i:'üçå',e:'Banana',s:'Pl√°tano'},{i:'üçá',e:'Grapes',s:'Uvas'},{i:'üçä',e:'Orange',s:'Naranja'},{i:'üçì',e:'Strawberry',s:'Fresa'}],
        colors: [{i:'üî¥',e:'Red',s:'Rojo'},{i:'üîµ',e:'Blue',s:'Azul'},{i:'üü¢',e:'Green',s:'Verde'},{i:'üü°',e:'Yellow',s:'Amarillo'}],
        family: [{i:'üë®',e:'Father',s:'Pap√°'},{i:'üë©',e:'Mother',s:'Mam√°'},{i:'üë∂',e:'Baby',s:'Beb√©'}],
        body: [{i:'üëÄ',e:'Eyes',s:'Ojos'},{i:'üëÉ',e:'Nose',s:'Nariz'},{i:'üëÑ',e:'Mouth',s:'Boca'}],
        numbers: [{i:'1Ô∏è‚É£',e:'One',s:'1'},{i:'2Ô∏è‚É£',e:'Two',s:'2'},{i:'3Ô∏è‚É£',e:'Three',s:'3'}],
        verbs: [{i:'üèÉ',e:'Run',s:'Correr'},{i:'üèä',e:'Swim',s:'Nadar'},{i:'üìñ',e:'Read',s:'Leer'}]
    };

    // --- PACKS CRUCIGRAMA (5 NIVELES) ---
    const packs = [
        { id:0, title:"Nivel 1: Colores", diff:"F√°cil", s:3, l:[['R','E','D'],['#','#','O'],['#','#','G']], c:["1. Color de la sangre","2. Animal que ladra"], sol:{'0-0':'R','0-1':'E','0-2':'D','1-2':'O','2-2':'G'} },
        { id:1, title:"Nivel 2: Mascotas", diff:"F√°cil", s:4, l:[['C','A','T','#'],['#','#','O','#'],['#','#','A','#'],['#','#','D','#']], c:["1. Animal que dice miau","2. Animal verde que salta"], sol:{'0-0':'C','0-1':'A','0-2':'T','1-2':'O','2-2':'A','3-2':'D'} },
        { id:2, title:"Nivel 3: N√∫meros", diff:"Medio", s:4, l:[['T','E','N','#'],['W','#','I','#'],['O','#','N','#'],['#','#','E','#']], c:["1. N√∫mero 10","2. N√∫mero 2","3. N√∫mero 9"], sol:{'0-0':'T','0-1':'E','0-2':'N','1-0':'W','2-0':'O','1-2':'I','2-2':'N','3-2':'E'} },
        { id:3, title:"Nivel 4: Familia", diff:"Medio", s:5, l:[['M','O','M','#','#'],['#','#','O','#','#'],['#','#','T','#','#'],['#','#','H','#','#'],['#','#','E','R','#']], c:["1. Mam√° (Forma corta)","2. Madre (Forma larga)"], sol:{'0-0':'M','0-1':'O','0-2':'M','1-2':'O','2-2':'T','3-2':'H','4-2':'E','4-3':'R'} },
        { id:4, title:"Nivel 5: Cuerpo", diff:"Dif√≠cil", s:7, l:[['H','A','N','D','#','#','#'],['E','#','#','#','L','#','#'],['A','#','#','#','E','#','#'],['D','#','#','#','G','#','#'],['#','#','#','#','#','#','#'],['#','N','O','S','E','#','#'],['#','#','#','#','#','#','#']], c:["1. Mano (5 dedos)","2. Nariz para oler","3. Cabeza","4. Pierna"], sol:{'0-0':'H','0-1':'A','0-2':'N','0-3':'D', '5-1':'N','5-2':'O','5-3':'S','5-4':'E', '0-0':'H','1-0':'E','2-0':'A','3-0':'D', '1-4':'L','2-4':'E','3-4':'G'} }
    ];

    // INIT
    window.onload = () => {
        document.getElementById('points').innerText = pts;
    };

    function enterApp() {
        document.getElementById('welcomeScreen').style.transform = "translateY(-100%)";
        playSfx('win');
    }

    function speak(txt, lang='en-US') {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(txt);
        u.lang = lang; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    function openModal(id){document.getElementById(id).style.display='flex';}
    function closeModal(id){document.getElementById(id).style.display='none';}

    // --- CATEGORIAS ---
    function openCategory(cat, title) {
        document.getElementById('catTitle').innerText = title;
        const grid = document.getElementById('catDetailGrid');
        grid.innerHTML = '';
        if(db[cat]) {
            db[cat].forEach(i => {
                let el = document.createElement('div'); el.className='detail-card';
                el.innerHTML = `<div style="font-size:2.5rem">${i.i}</div><div style="font-weight:bold;color:#555;margin-top:5px;">${i.s}</div>`;
                el.onclick = () => speak(i.e);
                grid.appendChild(el);
            });
        }
        openModal('modalCategory');
    }

    // --- TRADUCTOR ---
    function startVoiceTranslation() {
        if(isListening) { if(recognition) recognition.stop(); resetMic(); return; }
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) { alert("Navegador no soporta voz"); return; }
        
        recognition = new Speech();
        recognition.lang = document.getElementById('sourceLang').value;
        const target = document.getElementById('targetLang').value;
        
        const mic = document.getElementById('micBtn');
        mic.classList.add('listening');
        document.getElementById('voiceStatus').innerText = "Escuchando...";
        isListening = true;
        
        recognition.onresult = (e) => {
            const txt = e.results[0][0].transcript;
            translateAndSpeak(txt, target);
        };
        recognition.onend = resetMic;
        recognition.start();
    }

    function resetMic() {
        isListening = false;
        document.getElementById('micBtn').classList.remove('listening');
        document.getElementById('voiceStatus').innerText = "Toca y habla...";
    }

    async function translateAndSpeak(text, target) {
        try{
            const source = document.getElementById('sourceLang').value.split('-')[0];
            let r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(text)}`);
            let j = await r.json();
            let trans = j[0][0][0];
            
            document.getElementById('voiceStatus').innerText = `${text} ‚ûù ${trans}`;
            
            let langMap = {'en':'en-US','fr':'fr-FR','it':'it-IT','de':'de-DE'};
            speak(trans, langMap[target] || 'en-US');
        } catch(e) { speak("Error"); }
    }

    // --- CRUCIGRAMA ---
    let currentPack, selectedCell, currentDir='H', gridState;
    function openCrosswordMenu() {
        openModal('packsScreen');
        const grid = document.getElementById('packsGrid'); grid.innerHTML = '';
        packs.forEach((p, idx) => {
            let c = document.createElement('div'); c.className = 'modern-card';
            c.style.borderLeft = `5px solid ${p.diff==='F√°cil'?'#58cc02':'#ff9600'}`;
            c.style.marginBottom = "10px";
            c.innerHTML = `<h3 style="margin:0">${p.title}</h3><p style="margin:0;color:#777">${p.diff} ‚Ä¢ ${p.s}x${p.s}</p>`;
            c.onclick = () => loadCrossword(idx);
            grid.appendChild(c);
        });
    }
    function closePacks() { document.getElementById('packsScreen').style.display='none'; }
    function closeGame() { document.getElementById('gameScreen').style.display='none'; }

    function loadCrossword(idx) {
        currentPack = packs[idx];
        document.getElementById('gameTitle').innerText = currentPack.title;
        document.getElementById('gameScreen').style.display = 'flex';
        buildBoard(currentPack);
    }

    function buildBoard(pack) {
        const board = document.getElementById('gridTable');
        board.style.gridTemplateColumns = `repeat(${pack.s}, 1fr)`;
        board.innerHTML = '';
        gridState = [];

        for(let r=0; r<pack.s; r++) {
            let rowArr = [];
            for(let c=0; c<pack.s; c++) {
                const char = pack.l[r][c];
                const cell = document.createElement('div');
                if(char === '#') cell.className = 'cw-cell black';
                else {
                    cell.className = 'cw-cell';
                    const input = document.createElement('input');
                    input.className = 'cw-input-hidden'; 
                    input.dataset.r = r; input.dataset.c = c;
                    cell.innerHTML = `<span class="val"></span>`;
                    cell.onclick = () => selectCell(r, c);
                    // Input real oculto
                }
                board.appendChild(cell);
                rowArr.push({el:cell, sol:char, val:''});
            }
            gridState.push(rowArr);
        }
        const inp = document.getElementById('hiddenInput');
        inp.oninput = (e) => handleInput(e.target.value);
    }

    function selectCell(r,c) {
        selectedCell = {r,c};
        const clue = currentPack.c.join(' | ');
        document.getElementById('currentClueDisplay').innerText = clue;
        updateVisuals();
        document.getElementById('hiddenInput').value = '';
        document.getElementById('hiddenInput').focus();
    }

    function updateVisuals() {
        document.querySelectorAll('.cw-cell').forEach(e => e.classList.remove('selected'));
        gridState[selectedCell.r][selectedCell.c].el.classList.add('selected');
    }

    function handleInput(char) {
        if(!char) return;
        let l = char.slice(-1).toUpperCase();
        let cell = gridState[selectedCell.r][selectedCell.c];
        cell.val = l;
        cell.el.querySelector('.val').innerText = l;
        
        // Simple auto advance H
        if(selectedCell.c + 1 < currentPack.s && gridState[selectedCell.r][selectedCell.c+1].sol !== '#') {
            selectCell(selectedCell.r, selectedCell.c+1);
        }
    }

    function checkCrossword() {
        let correct = true;
        for(let r=0; r<gridState.length; r++) {
            for(let c=0; c<gridState[0].length; c++) {
                let cell = gridState[r][c];
                if(cell.sol !== '#') {
                    if(cell.val !== cell.sol) { cell.el.style.color='red'; correct=false; }
                    else { cell.el.style.color='#58cc02'; }
                }
            }
        }
        if(correct) { playSfx('win'); speak("Excellent!"); setTimeout(closeGame, 2000); }
    }

    // --- ETAPAS ---
    function openStages() {
        openModal('modalStages');
        const cont = document.getElementById('pathContainer');
        cont.innerHTML = '';
        for(let i=1; i<=10; i++) {
            let node = document.createElement('div');
            node.className = i <= unlockedLevel ? 'level-node' : 'level-node locked';
            node.innerText = i;
            if(i <= unlockedLevel) node.onclick = () => startQuiz(i);
            cont.appendChild(node);
            if(i<10) {
                let line = document.createElement('div');
                line.className = 'path-line';
                cont.appendChild(line);
            }
        }
    }

    function startQuiz() {
        openModal('modalQuiz');
        // Demo quiz logic
        document.getElementById('quizPrompt').innerText = "¬øC√≥mo se dice Perro?";
        const opts = document.getElementById('quizOptions');
        opts.innerHTML = `<div class="modern-card" onclick="playSfx('correct');alert('Bien!')">Dog</div><div class="modern-card" onclick="playSfx('wrong')">Cat</div>`;
    }

</script>
</body>
</html>




